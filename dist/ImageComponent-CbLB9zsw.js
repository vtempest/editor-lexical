import{jsx as e,jsxs as t,Fragment as r}from"react/jsx-runtime";import{useCollaborationContext as a}from"@lexical/react/LexicalCollaborationContext";import{CollaborationPlugin as o}from"@lexical/react/LexicalCollaborationPlugin";import{useLexicalComposerContext as i}from"@lexical/react/LexicalComposerContext";import{LexicalErrorBoundary as n}from"@lexical/react/LexicalErrorBoundary";import{HashtagPlugin as l}from"@lexical/react/LexicalHashtagPlugin";import{HistoryPlugin as s}from"@lexical/react/LexicalHistoryPlugin";import{LexicalNestedComposer as c}from"@lexical/react/LexicalNestedComposer";import{RichTextPlugin as m}from"@lexical/react/LexicalRichTextPlugin";import{useLexicalEditable as d}from"@lexical/react/useLexicalEditable";import{useLexicalNodeSelection as u}from"@lexical/react/useLexicalNodeSelection";import{mergeRegister as h}from"@lexical/utils";import{createCommand as g,$getSelection as f,$isNodeSelection as p,$setSelection as x,$isRangeSelection as C,SELECTION_CHANGE_COMMAND as w,COMMAND_PRIORITY_LOW as E,DRAGSTART_COMMAND as b,CLICK_COMMAND as L,KEY_ENTER_COMMAND as N,KEY_ESCAPE_COMMAND as v,$getNodeByKey as y,$getRoot as R,BLUR_COMMAND as S,COMMAND_PRIORITY_EDITOR as W}from"lexical";import{useRef as I,useState as _,useMemo as M,useCallback as T,useEffect as H,Suspense as P}from"react";import{O as z,Q as A,U as B,V as D,W as K,Y as j,Z as G,a0 as k,a1 as O,a2 as V,a3 as F,a4 as Q}from"./editor-Dv-3TiYC.js";import{I as U}from"./ImageResizer-CaFUJnn3.js";const Y=/* @__PURE__ */new Map,Z=g("RIGHT_CLICK_IMAGE_COMMAND");function q({setShowCaption:e}){const[t]=i();return H(()=>t.registerCommand(S,()=>(Q()&&e(!1),!1),W)),null}function J({altText:t,className:r,imageRef:a,src:o,width:i,height:n,maxWidth:l,onError:s}){const c=function(e){return e.toLowerCase().endsWith(".svg")}(o),m=function(e){let t=Y.get(e);if(t&&"error"in t&&"boolean"==typeof t.error)return t;if(!t)throw t=new Promise(t=>{const r=new Image;r.src=e,r.onload=()=>t({error:!1,height:r.naturalHeight,width:r.naturalWidth}),r.onerror=()=>t({error:!0})}).then(t=>(Y.set(e,t),t)),Y.set(e,t),t;throw t}(o);if(H(()=>{m.error&&s()},[m.error,s]),m.error)/* @__PURE__ */
return e(X,{});const d=(()=>{if(!c)return{height:n,maxWidth:l,width:i};let e=m.width,t=m.height;if(e>l){const r=l/e;e=l,t=Math.round(t*r)}if(t>500){const r=500/t;t=500,e=Math.round(e*r)}return{height:t,maxWidth:l,width:e}})();/* @__PURE__ */
return e("img",{className:r||void 0,src:o,alt:t,ref:a,style:d,onError:s,draggable:"false"})}function X(){/* @__PURE__ */
return e("img",{src:F,style:{height:200,opacity:.2,width:200},draggable:"false",alt:"Broken image"})}function $(){}function ee({src:g,altText:S,nodeKey:W,width:F,height:Q,maxWidth:Y,resizable:ee,showCaption:te,caption:re,captionsEnabled:ae}){const oe=I(null),ie=I(null),[ne,le,se]=u(W),[ce,me]=_(!1),{isCollabActive:de}=a(),[ue]=i(),he=I(null),[ge,fe]=_(!1),pe=d(),xe=M(()=>ne&&ue.getEditorState().read(()=>{const e=f();return p(e)&&e.has(W)}),[ue,ne,W]),Ce=T(e=>{const t=f(),r=ie.current;if(p(t)&&t.has(W)&&1===t.getNodes().length){if(te)return x(null),e.preventDefault(),re.focus(),!0;if(null!==r&&r!==document.activeElement)return e.preventDefault(),r.focus(),!0}return!1},[re,W,te]),we=T(e=>(he.current===re||ie.current===e.target)&&(x(null),ue.update(()=>{le(!0);const e=ue.getRootElement();null!==e&&e.focus()}),!0),[re,ue,le]),Ee=T(e=>{const t=e;return!!ce||t.target===oe.current&&(t.shiftKey?le(!ne):(se(),le(!0)),!0)},[ce,ne,le,se]),be=T(e=>{ue.getEditorState().read(()=>{const t=f();"IMG"===e.target.tagName&&C(t)&&1===t.getNodes().length&&ue.dispatchCommand(Z,e)})},[ue]);H(()=>h(ue.registerCommand(w,(e,t)=>(he.current=t,!1),E),ue.registerCommand(b,e=>e.target===oe.current&&(e.preventDefault(),!0),E)),[ue]),H(()=>{let e=$;return h(ue.registerCommand(L,Ee,E),ue.registerCommand(Z,Ee,E),ue.registerCommand(N,Ce,E),ue.registerCommand(v,we,E),ue.registerRootListener(t=>{e(),e=$,t&&(t.addEventListener("contextmenu",be),e=()=>t.removeEventListener("contextmenu",be))}),()=>e())},[ue,Ce,we,Ee,be]);const Le=e=>{ue.update(()=>{const t=y(W);V(t)&&(t.setShowCaption(e),e&&t.__caption.update(()=>{f()||R().selectEnd()}))})},{historyState:Ne}=z(),{settings:{showNestedEditorTreeView:ve}}=A(),ye=(ne||ce)&&pe;/* @__PURE__ */
return e(P,{fallback:null,children:/* @__PURE__ */t(r,{children:[/* @__PURE__ */e("div",{draggable:xe&&!ce,children:ge?/* @__PURE__ */e(X,{}):/* @__PURE__ */e(J,{className:ye?"focused "+(xe?"draggable":""):null,src:g,altText:S,imageRef:oe,width:F,height:Q,maxWidth:Y,onError:()=>fe(!0)})}),te&&/* @__PURE__ */e("div",{className:"image-caption-container",children:/* @__PURE__ */t(c,{initialEditor:re,children:[/* @__PURE__ */e(q,{setShowCaption:Le}),/* @__PURE__ */e(B,{}),/* @__PURE__ */e(D,{}),/* @__PURE__ */e(K,{}),/* @__PURE__ */e(l,{}),/* @__PURE__ */e(j,{}),de?/* @__PURE__ */e(o,{id:re.getKey(),providerFactory:G,shouldBootstrap:!0}):/* @__PURE__ */e(s,{externalHistoryState:Ne}),/* @__PURE__ */e(m,{contentEditable:/* @__PURE__ */e(k,{placeholder:"Enter a caption...",placeholderClassName:"ImageNode__placeholder",className:"ImageNode__contentEditable"}),ErrorBoundary:n}),!0===ve?/* @__PURE__ */e(O,{}):null]})}),ee&&xe&&ye&&/* @__PURE__ */e(U,{showCaption:te,setShowCaption:Le,editor:ue,buttonRef:ie,imageRef:oe,maxWidth:Y,onResizeStart:()=>{me(!0)},onResizeEnd:(e,t)=>{setTimeout(()=>{me(!1)},200),ue.update(()=>{const r=y(W);V(r)&&r.setWidthAndHeight(e,t)})},captionsEnabled:!ge&&ae})]})})}export{Z as RIGHT_CLICK_IMAGE_COMMAND,ee as default};
