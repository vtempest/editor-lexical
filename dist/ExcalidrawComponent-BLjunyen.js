import{jsx as e,jsxs as t,Fragment as i}from"react/jsx-runtime";import{useLexicalComposerContext as n}from"@lexical/react/LexicalComposerContext";import{useLexicalEditable as a}from"@lexical/react/useLexicalEditable";import{useLexicalNodeSelection as l}from"@lexical/react/useLexicalNodeSelection";import{mergeRegister as s}from"@lexical/utils";import{CLICK_COMMAND as o,isDOMNode as r,COMMAND_PRIORITY_LOW as m,$getNodeByKey as c}from"lexical";import{useState as u,useEffect as h,useRef as d,useCallback as p,useMemo as f}from"react";import{K as g,M as b,$ as x}from"./editor-Dv-3TiYC.js";import{I as S}from"./ImageResizer-CaFUJnn3.js";function w({elements:t,files:i,imageContainerRef:n,appState:a,rootClassName:l=null,width:s="inherit",height:o="inherit"}){const[r,m]=u(null);h(()=>{(async()=>{const e=await g({appState:a,elements:t,files:i});(e=>{const t=e?.firstElementChild?.firstElementChild,i=e.getAttribute("viewBox");if(null!=i){const t=i.split(" ");e.setAttribute("width",t[2]),e.setAttribute("height",t[3])}t&&"style"===t.tagName&&t.remove()})(e),e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("display","block"),m(e)})()},[t,i,a]);const c={};return"inherit"!==s&&(c.width=`${s}px`),"inherit"!==o&&(c.height=`${o}px`),/* @__PURE__ */e("div",{ref:e=>{e&&n&&(n.current=e)},className:l??"",style:c,dangerouslySetInnerHTML:{__html:r?.outerHTML??""}})}function C({nodeKey:g,data:C,width:v,height:y}){const[N]=n(),A=a(),[E,R]=u("[]"===C&&N.isEditable()),L=d(null),O=d(null),j=d(null),[k,D,I]=l(g),[M,z]=u(!1);h(()=>{if(A)return s(N.registerCommand(o,e=>{const t=O.current,i=e.target;return!!M||!(null===t||!r(i)||!t.contains(i))&&(e.shiftKey||I(),D(!k),e.detail>1&&R(!0),!0)},m));k&&I()},[I,N,k,M,D,A]);const H=p(()=>(R(!1),N.update(()=>{const e=c(g);e&&e.remove()})),[N,g]),K=p(()=>{R(!0)},[]),{elements:T=[],files:$={},appState:J={}}=f(()=>JSON.parse(C),[C]),_=p(()=>{R(!1),0===T.length&&N.update(()=>{const e=c(g);e&&e.remove()})},[N,g,T.length]);/* @__PURE__ */
return t(i,{children:[A&&E&&/* @__PURE__ */e(b,{initialElements:T,initialFiles:$,initialAppState:J,isShown:E,onDelete:H,onClose:_,onSave:(e,t,i)=>{((e,t,i)=>{N.update(()=>{const n=c(g);x(n)&&(e&&e.length>0||Object.keys(i).length>0?n.setData(JSON.stringify({appState:t,elements:e,files:i})):n.remove())})})(e,t,i),R(!1)},closeOnClickOutside:!1}),T.length>0&&/* @__PURE__ */t("button",{ref:O,className:"excalidraw-button "+(k?"selected":""),children:[/* @__PURE__ */e(w,{imageContainerRef:L,className:"image",elements:T,files:$,appState:J,width:v,height:y}),k&&A&&/* @__PURE__ */e("div",{className:"image-edit-button",role:"button",tabIndex:0,onMouseDown:e=>e.preventDefault(),onClick:K}),(k||M)&&A&&/* @__PURE__ */e(S,{buttonRef:j,showCaption:!0,setShowCaption:()=>null,imageRef:L,editor:N,onResizeStart:()=>{z(!0)},onResizeEnd:(e,t)=>{setTimeout(()=>{z(!1)},200),N.update(()=>{const i=c(g);x(i)&&(i.setWidth(e),i.setHeight(t))})},captionsEnabled:!0})]})]})}export{C as default};
